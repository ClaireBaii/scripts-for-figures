
# fig5_threshold_sensitivity_table.R
# Purpose: Generate threshold sensitivity analysis table for Figure 5

suppressPackageStartupMessages({
  library(igraph)
  library(Hmisc) 
  library(dplyr)
  library(tidyr)
  library(readr)
})

set.seed(123)

# Define comparisons
comparisons <- list(
  list(name = "exudate",       thr_high = 0.7, thr_low = 0.5, file_key = "exudate"),
  list(name = "microbe_genus", thr_high = 0.7, thr_low = 0.5, file_key = "microbe")
)

# Input files (Using relative paths)
# Note: These filenames contain non-ASCII characters. 
# Ensure script is saved/read as UTF-8 or system default.
f_exudate <- "data/完整数据-分泌物.csv"
f_microbe <- "data/完整数据-微生物.csv"

f_out <- "figure5/FigS5_threshold_sensitivity_table.csv"

# Function to load and preprocess data
load_data_matrix <- function(file_path, type = "exudate") {
  if (!file.exists(file_path)) stop(paste("File not found:", file_path))
  
  # Try reading with default encoding
  df <- read.csv(file_path, check.names = FALSE, stringsAsFactors = FALSE)
  
  if (type == "exudate") {
    if (!"Name" %in% colnames(df)) stop("Exudate file missing 'Name' column")
    sample_cols <- grep("^YS", colnames(df), value = TRUE)
    if (length(sample_cols) == 0) stop("No sample columns found in exudate data")
    mat <- t(as.matrix(df[, sample_cols]))
    colnames(mat) <- df$Name
    
  } else if (type == "microbe") {
    sample_cols <- grep("^RDYS", colnames(df), value = TRUE)
    if (length(sample_cols) == 0) stop("No sample columns found in microbe data")
    id_col <- colnames(df)[1] 
    ids <- df[, id_col]
    if (any(duplicated(ids))) {
      ids <- make.unique(as.character(ids))
    }
    mat <- t(as.matrix(df[, sample_cols]))
    colnames(mat) <- ids
  }
  
  # Remove features with zero variance
  vars <- apply(mat, 2, var, na.rm = TRUE)
  mat <- mat[, vars > 0, drop = FALSE]
  
  return(mat)
}

# Function to calculate network metrics
calc_topology <- function(mat, threshold, p_cutoff = 0.05, metric_top_hubs = 8) {
  
  cor_res <- rcorr(as.matrix(mat), type = "spearman")
  r_mat <- cor_res$r
  p_mat <- cor_res$P
  
  lt <- lower.tri(r_mat)
  edges <- data.frame(
    from = rownames(r_mat)[row(r_mat)[lt]],
    to = colnames(r_mat)[col(r_mat)[lt]],
    r = r_mat[lt],
    p = p_mat[lt]
  )
  
  edges$p_adj <- p.adjust(edges$p, method = "BH")
  
  edges_keep <- edges %>%
    filter(abs(r) >= threshold, p_adj < p_cutoff)
  
  if (nrow(edges_keep) == 0) {
    return(list(
      nodes = 0, edges = 0, avg_degree = 0, modularity = 0,
      hubs = character(0)
    ))
  }
  
  g <- graph_from_data_frame(edges_keep, directed = FALSE)
  
  degs <- degree(g)
  avg_degree <- mean(degs)
  
  mod_val <- NA
  if (vcount(g) > 1) {
    try({
      cl <- cluster_louvain(g)
      mod_val <- modularity(cl)
    }, silent = TRUE)
  }
  if (is.na(mod_val)) mod_val <- 0
  
  hubs <- names(sort(degs, decreasing = TRUE))[1:min(metric_top_hubs, length(degs))]
  
  return(list(
    nodes = vcount(g),
    edges = ecount(g),
    avg_degree = avg_degree,
    modularity = mod_val,
    hubs = hubs
  ))
}

# Main Execution
results_list <- list()

for (comp in comparisons) {
  cat(sprintf("Processing %s (High: %.2f, Low: %.2f)...\n", comp$name, comp$thr_high, comp$thr_low))
  
  f_path <- ifelse(comp$file_key == "exudate", f_exudate, f_microbe)
  # Ensure file exists before proceeding
  if(!file.exists(f_path)) {
      cat(sprintf("Critical Error: File %s not found.\n", f_path))
      next
  }

  mat <- load_data_matrix(f_path, type = comp$file_key)
  cat(sprintf("  Data loaded. Shape: %d samples x %d features\n", nrow(mat), ncol(mat)))
  
  cat("  Calculating High Threshold...\n")
  res_high <- calc_topology(mat, comp$thr_high)
  
  cat("  Calculating Low Threshold...\n")
  res_low <- calc_topology(mat, comp$thr_low)
  
  hubs_high <- res_high$hubs
  hubs_low <- res_low$hubs
  
  hub_intersect <- length(intersect(hubs_high, hubs_low))
  hub_union <- length(union(hubs_high, hubs_low))
  jaccard <- ifelse(hub_union > 0, hub_intersect / hub_union, 0)
  
  row_df <- data.frame(
    dataset = comp$name,
    thr_high = comp$thr_high,
    thr_low = comp$thr_low,
    modularity_high = res_high$modularity,
    modularity_low = res_low$modularity,
    avg_degree_high = res_high$avg_degree,
    avg_degree_low = res_low$avg_degree,
    edges_high = res_high$edges,
    edges_low = res_low$edges,
    nodes_high = res_high$nodes,
    nodes_low = res_low$nodes,
    modularity_delta = res_high$modularity - res_low$modularity,
    hub_top_n = 8,
    hub_overlap_n = hub_intersect,
    hub_jaccard = jaccard
  )
  
  results_list[[length(results_list) + 1]] <- row_df
}

final_df <- do.call(rbind, results_list)
write.csv(final_df, f_out, row.names = FALSE, quote = FALSE)

cat(sprintf("\nAnalysis complete. Results saved to %s\n", f_out))
